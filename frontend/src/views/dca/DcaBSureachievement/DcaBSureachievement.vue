<template>
  <a-card title="医疗认可">
    <div>
      <a-button @click="handleAdd" type="primary" :loading="loading"
        >添加行</a-button
      >
      <a-button @click="handleDelete" type="primary" :loading="loading"
        >删除行</a-button
      >
    </div>
    <a-table
      :columns="columns"
      :data-source="dataSource"
      :rowKey="(record) => record.id"
      :rowSelection="{
        selectedRowKeys: selectedRowKeys,
        onChange: onSelectChange,
      }"
      bordered
      :scroll="scroll"
    >
      <template slot="achievementName" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text }}
        </div>
        <div v-else>
          <a-select
            :value="record.achievementName"
            style="width: 430px;"
            @change="
              (e, f) => handleSelectChange(e, f, record, 'achievementName')
            "
          >
            <a-select-option
              value="获得国家拥有自主知识产权的国家一类新药的研制者第一名"
              >获得国家拥有自主知识产权的国家一类新药的研制者第一名</a-select-option
            >
            <a-select-option value="现任中央干部保健专家委员会成员"
              >现任中央干部保健专家委员会成员</a-select-option
            >
            <a-select-option
              value="医疗技术精湛，首次提出了针对某种疾病的预防、诊断和治疗方法或某一新的医学理论，有创新性，在临床取得良好效果，并在中华医学系列及以上杂志发表论文，经医疗管理部门推荐，医院学术委员会投票表决通过者"
              >医疗技术精湛，首次提出了针对某种疾病的预防、诊断和治疗方法或某一新的医学理论，有创新性，在临床取得良好效果，并在中华医学系列及以上杂志发表论文，经医疗管理部门推荐，医院学术委员会投票表决通过者</a-select-option
            >
            <a-select-option
              value="任正高职务12年以上，医疗技术高超，是国内医疗界本专业领域的权威，并得到公认者"
              >任正高职务12年以上，医疗技术高超，是国内医疗界本专业领域的权威，并得到公认者</a-select-option
            >
            <a-select-option
              value="获得国家拥有自主知识产权的国家一类新药的研制者的前两名或二类新药的研制者第一名"
              >获得国家拥有自主知识产权的国家一类新药的研制者的前两名或二类新药的研制者第一名</a-select-option
            >
            <a-select-option
              value="医疗技术精良，首次提出了针对某种疾病的预防、诊断和治疗方法或某一新的医学理论，有创新性，在临床取得良好效果，并在中华医学系列及以上杂志发表论文，经医疗管理部门推荐，医院学术委员会投票表决通过者"
              >医疗技术精良，首次提出了针对某种疾病的预防、诊断和治疗方法或某一新的医学理论，有创新性，在临床取得良好效果，并在中华医学系列及以上杂志发表论文，经医疗管理部门推荐，医院学术委员会投票表决通过者</a-select-option
            >
          </a-select>
        </div>
      </template>
      <template slot="rankIndex" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text }}
        </div>
        <div v-else>
          <a-input-number
            style="width: 100%"
            @blur="(e) => inputChange(e.target.value, record, 'rankIndex')"
            :value="record.rankIndex"
            :precision="0"
          >
          </a-input-number>
        </div>
      </template>
      <template slot="achievementGrade" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text }}
        </div>
        <div v-else>
          <a-select
            :value="record.achievementGrade"
            style="width: 100%"
            @change="
              (e, f) => handleSelectChange(e, f, record, 'achievementGrade')
            "
          >
            <a-select-option value="一"> 一 </a-select-option>
            <a-select-option value="二"> 二 </a-select-option>
            <a-select-option value="三"> 三 </a-select-option>
          </a-select>
        </div>
      </template>
      <template slot="achievementDate" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text == "" || text == null ? "" : text.substr(0, 10) }}
        </div>
        <div v-else>
          <a-date-picker
            :defaultValue="
              text == '' || text == null ? '' : moment(text, dateFormat)
            "
            @change="(e, f) => handleChange(e, f, record, 'achievementDate')"
          />
        </div>
      </template>
      <template slot="achievementDefine" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text }}
        </div>
        <div v-else>
          <a-textarea
            @blur="
              (e) => inputChange(e.target.value, record, 'achievementDefine')
            "
            :value="record.achievementDefine"
          >
          </a-textarea>
        </div>
      </template>
      <template slot="achievementContent" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          {{ text }}
        </div>
        <div v-else>
          <a-textarea
            @blur="
              (e) => inputChange(e.target.value, record, 'achievementContent')
            "
            :value="record.achievementContent"
          >
          </a-textarea>
        </div>
      </template>
      <template slot="fileId" slot-scope="text, record">
        <div v-if="record.state == 3 || record.state == 1">
          <a
            :href="record.fileUrl"
            v-if="text != null && text != ''"
            target="_blank"
            >查看</a
          >
        </div>
        <div v-else>
          <a-button type="dashed" block @click="OpenFile(record)">
            {{
              record.fileId != null && record.fileId != "" ? "已上传" : "上传"
            }}
          </a-button>
        </div>
      </template>
      <template slot="isUse" slot-scope="text, record">
        <a-checkbox
          @change="(e) => onIsUseChange(e, record, 'isUse')"
          :checked="text"
        ></a-checkbox>
      </template>
    </a-table>
    <div>
      <a-button @click="handleSave" type="primary" :loading="loading"
        >保存草稿</a-button
      >
      <a-button @click="handleSubmit" type="primary" :loading="loading"
        >全部提交</a-button
      >
    </div>
    <tableUpload-file
      ref="upFile"
      :fileId="editRecord.fileId"
      :fileVisiable="fileVisiable"
      @setFileId="setFileId"
    >
    </tableUpload-file>
  </a-card>
</template>

<script>
import moment from "moment";
import TableUploadFile from "../../common/TableUploadFile";
export default {
  data() {
    return {
      dateFormat: "YYYY-MM-DD",
      dataSource: [],
      selectedRowKeys: [],
      loading: false,
      CustomVisiable: false,
      idNums: 10000,
      fileVisiable: false,
      editRecord: {
        fileId: "",
      },
      scroll: {
        x: 1500,
        y: window.innerHeight - 200 - 100 - 20 - 80,
      },
    };
  },
  components: { TableUploadFile },
  mounted() {
    this.fetch();
  },
  methods: {
    moment,
    showFile(record) {
      window.location.href = record.fileUrl;
    },
    OpenFile(record) {
      this.editRecord = record;
      this.fileVisiable = true;
      if (record.fileId != undefined && record.fileId != "") {
        this.$refs.upFile.fetch(record.fileId);
      }
    },
    setFileId(fileId, fileUrl) {
      this.fileVisiable = false;
      console.log(fileUrl);
      /**
       const dataSource = [...this.dataSource]
       console.log(this.editRecord.id)
       let record=dataSource.filter(p=>p.id===this.editRecord.id)
       console.log(record)*/
      this.editRecord["fileId"] = fileId;
      this.editRecord["fileUrl"] = fileUrl;
      //this.dataSource =[...dataSource]
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      // console.log(selectedRows)
      if (selectedRows.length > 0) {
        if (selectedRows[0].state != 3 && selectedRows[0].state != 1) {
          this.selectedRowKeys = selectedRowKeys;
        }
      } else {
        this.selectedRowKeys = selectedRowKeys;
      }
    },
    handleChange(date, dateStr, record, filedName) {
      const value = dateStr;
      record[filedName] = value;
    },
    inputChange(value, record, filedName) {
      console.info(value);
      record[filedName] = value;
    },
    handleSelectChange(value, option, record, filedName) {
      console.info(value);
      record[filedName] = value;
    },
    onIsUseChange(e, record, filedName) {
      record[filedName] = e.target.checked;
    },
    handleAdd() {
      for (let i = 0; i < 4; i++) {
        this.dataSource.push({
          id: (this.idNums + i + 1).toString(),
          state: 0,
          achievementName: "",
          rankIndex: "",
          achievementDate: "",
          achievementDefine: "",
          achievementContent: "",
          achievementGrade: "",
          isUse: false,
        });
      }
      this.idNums = this.idNums + 4;
    },
    handleSave() {
      const dataSourceAll = [...this.dataSource];
      const dataSource = dataSourceAll.filter(
        (p) => p.state == 0 || p.state == 2
      );
      let dataAdd = [];
      dataSource.forEach((element) => {
        if (
          element.achievementName != "" ||
          element.rankIndex != "" ||
          element.achievementDate != "" ||
          element.achievementDefine != "" ||
          element.achievementContent != ""
        ) {
          dataAdd.push(element);
        }
      });
      if (dataAdd.length === 0) {
        this.$message.warning("请填写数据！！！");
      } else {
        let jsonStr = JSON.stringify(dataAdd);
        this.loading = true;
        this.$post("dcaBSureachievement/addNew", {
          jsonStr: jsonStr,
          state: 0,
        })
          .then(() => {
            // this.reset()
            this.$message.success("保存成功");
            this.fetch();
            this.loading = false;
          })
          .catch(() => {
            this.loading = false;
          });
      }
    },
    handleSubmit() {
      let that = this;
      this.$confirm({
        title: "确定提交全部记录?",
        content: "当您点击确定按钮后，信息将不能修改",
        centered: true,
        onOk() {
          const dataSourceAll = [...that.dataSource];
          const dataSource = dataSourceAll.filter(
            (p) => p.state == 0 || p.state == 2
          );
          let dataAdd = [];
          dataSource.forEach((element) => {
            if (
              element.achievementName != "" ||
              element.rankIndex != "" ||
              element.achievementDate != "" ||
              element.achievementDefine != "" ||
              element.achievementContent != ""
            ) {
              dataAdd.push(element);
            }
          });
          if (dataAdd.length === 0) {
             setTimeout(() => { //hsc 2021 09 26 提交后跳转下一个
              that.$EventBus.$emit('selectMoudles',60)
            }, 300);
          } else {
            let jsonStr = JSON.stringify(dataAdd);
            that.loading = true;
            that
              .$post("dcaBSureachievement/addNew", {
                jsonStr: jsonStr,
                state: 1,
              })
              .then(() => {
                //this.reset()
                that.$message.success("提交成功");
               // that.fetch();
                that.CustomVisiable = false; //提交之后 不能再修改
                that.loading = false;
                 setTimeout(() => { //hsc 2021 09 26 提交后跳转下一个
              that.$EventBus.$emit('selectMoudles',60)
            }, 300);
              })
              .catch(() => {
                that.loading = false;
              });
          }
        },
        onCancel() {
          that.selectedRowKeys = [];
        },
      });
    },
    handleDelete() {
      if (!this.selectedRowKeys.length || this.selectedRowKeys.length > 1) {
        this.$message.warning("请选择一条需要删除的记录");
        return;
      }
      let that = this;
      this.$confirm({
        title: "确定删除所选中的记录?",
        content: "当您点击确定按钮后，这些记录将会被彻底删除",
        centered: true,
        onOk() {
          let dcaBPatentIds = that.selectedRowKeys.join(",");
          const dataSource = [...that.dataSource];
          let new_dataSource = dataSource.filter(
            (p) => that.selectedRowKeys.indexOf(p.id) < 0
          );
          that
            .$put("dcaBSureachievement", {
              id: that.selectedRowKeys[0],
              isDeletemark: 0,
            })
            .then(() => {})
            .catch(() => {});
          that.dataSource = new_dataSource;
          that.$message.success("删除成功");
          that.selectedRowKeys = [];
        },
        onCancel() {
          that.selectedRowKeys = [];
        },
      });
    },
    fetch() {
      this.$get("dcaBSureachievement/custom", {}).then((r) => {
        let data = r.data;
        this.dataSource = data.rows;

        for (let i = 0; i < 4; i++) {
          this.dataSource.push({
            id: (this.idNums + i + 1).toString(),
            state: 0,
            achievementName: "",
            rankIndex: "",
            achievementDate: "",
            achievementDefine: "",
            achievementContent: "",
            achievementGrade: "",
            isUse: false,
          });
          this.idNums = this.idNums + 4;
        }
      });
    },
  },
  computed: {
    columns() {
      return [
        {
          title: "名称",
          dataIndex: "achievementName",
          width: 450,
          scopedSlots: { customRender: "achievementName" },
        },
        {
          title: "排名",
          dataIndex: "rankIndex",
          width: 80,
          scopedSlots: { customRender: "rankIndex" },
        },
        {
          title: "获得时间",
          dataIndex: "achievementDate",
          width: 120,
          scopedSlots: { customRender: "achievementDate" },
        },
        {
          title: "期限",
          dataIndex: "achievementDefine",
          width: 80,
          scopedSlots: { customRender: "achievementDefine" },
        },
        {
          title: "备注",
          dataIndex: "achievementContent",
          width: 200,
          scopedSlots: { customRender: "achievementContent" },
        },
        {
          title: "状态",
          dataIndex: "state",
          width: 100,
          customRender: (text, row, index) => {
            switch (text) {
              case 0:
                return <a-tag color="purple">未提交</a-tag>;
              case 1:
                return <a-tag color="green">已提交</a-tag>;
              case 2:
                return <a-tag color="red">审核未通过</a-tag>;
              case 3:
                return <a-tag color="#f50">已审核</a-tag>;
              default:
                return text;
            }
          },
        },
        {
          title: "审核意见",
          dataIndex: "auditSuggestion",
        },
        {
          title: "经审核是否构成职称晋升条件",
          dataIndex: "isUse",
          scopedSlots: { customRender: "isUse" },
          width: 80,
        },
        {
          title: "附件",
          dataIndex: "fileId",
          scopedSlots: { customRender: "fileId" },
          width: 80,
        },
      ];
    },
  },
};
</script>

<style lang="less" scoped>
@import "../../../../static/less/Common";
</style>
